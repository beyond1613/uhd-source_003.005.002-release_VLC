<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.8.1: http://docutils.sourceforge.net/" />
<title>UHD - Synchronization Application Notes</title>
<style type="text/css">

body{
font-family:Arial, Helvetica, sans-serif;
font-size:11pt;
color:black;
background-color:white;
width:90%;
margin:0 auto 0 auto;
}

div.document div.contents{
border:1px solid #333333;
padding:10px 30px 10px 10px;
margin-left:50px;
color:inherit;
background-color:#FCFCFC;
display:inline-block;
}

div.document p.topic-title{
font-weight:bold;
}

div.document a:link, div.document a:visited{
color:#236B8E;
background-color:inherit;
text-decoration:none;
}

div.document a:hover{
color:#4985D6;
background-color:inherit;
text-decoration:none;
}

div.document h1.title{
font-size:150%;
border-left:1px solid #333333;
border-bottom:1px solid #333333;
text-align:left;
padding:10px 0px 10px 10px;
margin:10px 5px 20px 5px;
color:#333333;
background-color:inherit;
}

div.document h2.subtitle, div.section h1{
margin-top:50px;
border-bottom:1px solid #333333;
font-size:140%;
text-align:center;
padding:20px 0px 10px 0px;
color:#333333;
background-color:inherit;
}

div.section h2{
font-size:110%;
text-align:left;
padding:15px 0px 5px 0px;
text-decoration:underline;
color:#333333;
background-color:inherit;
}

div.document pre.literal-block{
border:1px inset #333333;
padding:5px;
margin:10px 5px 10px 5px;
color:inherit;
background-color:#FCFCFC;
font-size:90%;
}

div.document table{
padding:5px;
font-size:95%;
}

div.document th{
padding:3px 7px 3px 7px;
border:1px solid #333333;
text-align:center;
color:inherit;
background-color:#ECECEC;
}

div.document tr{
}

div.document td{
padding:3px 7px 3px 7px;
border:1px solid #333333;
text-align:center;
color:inherit;
background-color:#FCFCFC;
}

div.footer{
margin:50px auto 30px auto;
text-align:center;
font-size:85%;
}

</style>
</head>
<body>
<div class="document" id="uhd-synchronization-application-notes">
<h1 class="title">UHD - Synchronization Application Notes</h1>

<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#common-reference-signals" id="id1">Common Reference Signals</a><ul>
<li><a class="reference internal" href="#pps-and-10-mhz-reference-signals" id="id2">PPS and 10 MHz reference signals</a></li>
<li><a class="reference internal" href="#mimo-cable-reference-signals" id="id3">MIMO cable reference signals</a></li>
</ul>
</li>
<li><a class="reference internal" href="#synchronizing-the-device-time" id="id4">Synchronizing the Device Time</a><ul>
<li><a class="reference internal" href="#method-1-poll-the-usrp-time-registers" id="id5">Method 1 - poll the USRP time registers</a></li>
<li><a class="reference internal" href="#method-2-query-the-gpsdo-for-seconds" id="id6">Method 2 - query the GPSDO for seconds</a></li>
<li><a class="reference internal" href="#method-3-internal-gpsdo" id="id7">Method 3 - internal GPSDO</a></li>
<li><a class="reference internal" href="#method-4-mimo-cable" id="id8">Method 4 - MIMO cable</a></li>
</ul>
</li>
<li><a class="reference internal" href="#synchronizing-channel-phase" id="id9">Synchronizing Channel Phase</a><ul>
<li><a class="reference internal" href="#align-cordics-in-the-dsp" id="id10">Align CORDICs in the DSP</a></li>
<li><a class="reference internal" href="#align-los-in-the-front-end-sbx-wbx-n-series" id="id11">Align LOs in the front-end (SBX/WBX + N-Series)</a></li>
<li><a class="reference internal" href="#align-los-in-the-front-end-others" id="id12">Align LOs in the front-end (others)</a></li>
</ul>
</li>
</ul>
</div>
<p>The following application notes explain how to synchronize multiple USRPs
with the goal of transmitting or receiving time-aligned samples for MIMO
or other applications requiring multiple USRPs operating synchronously.</p>
<p><strong>Note:</strong> The following synchronization notes do not apply to USRP1,
which does not support the advanced features available in newer products.</p>
<div class="section" id="common-reference-signals">
<h1>Common Reference Signals</h1>
<p>USRPs take two reference signals in order to synchronize clocks and time:</p>
<ul class="simple">
<li>A 10MHz reference to provide a single frequency reference for both devices.</li>
<li>A pulse-per-second (PPS) to synchronize the sample time across devices.</li>
<li>A MIMO cable transmits an encoded time message from one device to another.</li>
</ul>
<div class="section" id="pps-and-10-mhz-reference-signals">
<h2>PPS and 10 MHz reference signals</h2>
<p>Connect the front panel SMA connectors to the reference sources.
Typically, these signals are provided by an external GPSDO.
However, some USRP models can provide these signals from an optional internal GPSDO.</p>
<pre class="literal-block">
usrp-&gt;set_clock_source(&quot;external&quot;);
usrp-&gt;set_time_source(&quot;external&quot;);
</pre>
<p><strong>Note:</strong>
Sometimes the delay on the PPS signal will cause it to arrive inside the timing
margin the FPGA sampling clock, causing PPS edges to be separated by less or
more than 100 million cycles of the FPGA clock. If this is the case,
you can change the edge reference of the PPS signal with this parameter:</p>
<pre class="literal-block">
usrp-&gt;set_time_source(&quot;_external_&quot;);
</pre>
<p><strong>Note2:</strong>
For users generating their own signals for the external SMA connectors,
the PPS should be clocked from the 10MHz reference.
See the application notes for your device for specific signal requirements.</p>
</div>
<div class="section" id="mimo-cable-reference-signals">
<h2>MIMO cable reference signals</h2>
<p>Use the MIMO expansion cable to share reference sources (USRP2 and N-Series).
The MIMO cable can be used synchronize one device to another device.
Users of the MIMO cable may use Method 1 (explained below) to synchronize multiple pairs of devices.</p>
<pre class="literal-block">
usrp-&gt;set_clock_source(&quot;mimo&quot;);
usrp-&gt;set_time_source(&quot;mimo&quot;);
</pre>
</div>
</div>
<div class="section" id="synchronizing-the-device-time">
<h1>Synchronizing the Device Time</h1>
<p>The purpose of the PPS signal is to synchronously latch a time into the device.
You can use the <strong>set_time_next_pps(...)</strong> function to either initialize the sample time to 0
or an absolute time, such as GPS time or UTC time.
For the purposes of synchronizing devices,
it doesn't matter what time you initialize to when using <strong>set_time_next_pps(...)</strong>.</p>
<div class="section" id="method-1-poll-the-usrp-time-registers">
<h2>Method 1 - poll the USRP time registers</h2>
<p>One way to initialize the PPS edge is to poll the &quot;last PPS&quot; time from the USRP device.
When the last PPS time increments, the user can determine that a PPS has occurred:</p>
<pre class="literal-block">
const uhd::time_spec_t last_pps_time = usrp-&gt;get_time_last_pps();
while (last_pps_time == usrp-&gt;get_time_last_pps()){
    //sleep 100 milliseconds (give or take)
}
usrp-&gt;set_time_next_pps(uhd::time_spec_t(0.0));
</pre>
</div>
<div class="section" id="method-2-query-the-gpsdo-for-seconds">
<h2>Method 2 - query the GPSDO for seconds</h2>
<p>Most GPSDOs can be configured to output a NMEA string over the serial port once every PPS.
The user can wait for this string to determine the PPS edge,
and the user can also parse this string to determine GPS time:</p>
<pre class="literal-block">
//call user's function to wait for NMEA message...
usrp-&gt;set_time_next_pps(uhd::time_spec_t(0.0));

-- OR --

//call user's function to wait for NMEA message...
//call user's function to parse the NMEA message...
usrp-&gt;set_time_next_pps(uhd::time_spec_t(gps_time+1));
</pre>
</div>
<div class="section" id="method-3-internal-gpsdo">
<h2>Method 3 - internal GPSDO</h2>
<p>USRPs with internal GPSDOs properly configured will automatically
configure themselves to set the VITA time to current UTC time.
See the <a class="reference external" href="./gpsdo.html">GPSDO Application Notes</a> for more details.</p>
</div>
<div class="section" id="method-4-mimo-cable">
<h2>Method 4 - MIMO cable</h2>
<p>A USRP can synchronize its time to another USRP via the MIMO cable.
Unlike the other methods, this does not use a real &quot;pulse per second&quot;.
Rather, the USRP sends an encoded time message over the MIMO cable.
The slave device will automatically synchronize to the time on the master device.
See the <a class="reference external" href="./usrp2.html#using-the-mimo-cable">MIMO Cable Application Notes</a> for more detail.</p>
</div>
</div>
<div class="section" id="synchronizing-channel-phase">
<h1>Synchronizing Channel Phase</h1>
<div class="section" id="align-cordics-in-the-dsp">
<h2>Align CORDICs in the DSP</h2>
<p>In order to achieve phase alignment between USRPs, the CORDICS in both
devices must be aligned with respect to each other. This is easily achieved
by issuing stream commands with a time spec property, which instructs the
streaming to begin at a specified time. Since the devices are already
synchronized via the 10MHz and PPS inputs, the streaming will start at exactly
the same time on both devices. The CORDICs are reset at each start-of-burst
command, so users should ensure that every start-of-burst also has a time spec set.</p>
<p>For receive, a burst is started when the user issues a stream command. This stream command should have a time spec set:</p>
<pre class="literal-block">
uhd::stream_cmd_t stream_cmd(uhd::stream_cmd_t::STREAM_MODE_NUM_SAMPS_AND_DONE);
stream_cmd.num_samps = samps_to_recv;
stream_cmd.stream_now = false;
stream_cmd.time_spec = time_to_recv;
usrp-&gt;issue_stream_cmd(stream_cmd);
</pre>
<p>For transmit, a burst is started when the user calls send(). The metadata should have a time spec set:</p>
<pre class="literal-block">
uhd::tx_metadata_t md;
md.start_of_burst = true;
md.end_of_burst = false;
md.has_time_spec = true;
md.time_spec = time_to_send;

//send a single packet
size_t num_tx_samps = tx_streamer-&gt;send(buffs, samps_to_send, md);
</pre>
</div>
<div class="section" id="align-los-in-the-front-end-sbx-wbx-n-series">
<h2>Align LOs in the front-end (SBX/WBX + N-Series)</h2>
<p>Using timed commands, multiple frontends can be tuned at a specific time.
This timed-tuning ensures that the phase offsets between VCO/PLL chains
will remain constant after each re-tune. See notes below:</p>
<ul class="simple">
<li>There is a random phase offset between any two frontends</li>
<li>This phase offset is different for different LO frequencies</li>
<li>This phase offset remains constant after retuning<ul>
<li>Due to divider, WBX phase offset will be randomly +/- 180 deg after re-tune</li>
</ul>
</li>
<li>This phase offset will drift over time due to thermal and other characteristics</li>
<li>Periodic calibration will be necessary for phase-coherent applications</li>
</ul>
<p>Code snippet example, tuning with timed commands:</p>
<pre class="literal-block">
//we will tune the frontends in 100ms from now
uhd::time_spec_t cmd_time = usrp-&gt;get_time_now() + uhd::time_spec_t(0.1);

//sets command time on all devices
//the next commands are all timed
usrp-&gt;set_command_time(cmd_time);

//tune channel 0 and channel 1
usrp-&gt;set_rx_freq(1.03e9, 0/*ch0*/);
usrp-&gt;set_rx_freq(1.03e9, 1/*ch1*/);

//end timed commands
usrp-&gt;clear_command_time();
</pre>
</div>
<div class="section" id="align-los-in-the-front-end-others">
<h2>Align LOs in the front-end (others)</h2>
<p>After tuning the RF front-ends,
each local oscillator may have a random phase offset due to the dividers
in the VCO/PLL chains. This offset will remain constant after the device
has been initialized, and will remain constant until the device is closed
or re-tuned. This phase offset is typically removed by the user in MIMO
applications, using a training sequence to estimate the offset. It will
be necessary to re-align the LOs after each tune command.</p>
</div>
</div>
</div>
<div class="footer">
<hr class="footer" />
Generated on: 2015-05-18 08:53 UTC.

</div>
</body>
</html>
